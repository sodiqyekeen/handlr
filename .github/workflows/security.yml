name: Security Scan

on:
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM UTC
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_trufflehog:
        description: 'Run TruffleHog secret scanning'
        required: false
        default: true
        type: boolean
      run_codeql:
        description: 'Run CodeQL analysis'
        required: false
        default: true
        type: boolean
      run_dependency_scan:
        description: 'Run dependency vulnerability scan'
        required: false
        default: true
        type: boolean
      scan_depth:
        description: 'Scan depth for TruffleHog'
        required: false
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'shallow'
          - 'recent'

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    if: inputs.run_dependency_scan != false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Check for vulnerable packages
      run: |
        echo "Checking for vulnerable NuGet packages..."
        dotnet list package --vulnerable --include-transitive > vulnerability-report.txt 2>&1
        
        # Check if the scan actually found any projects
        if grep -q "No projects found" vulnerability-report.txt; then
          echo "âš ï¸  No projects found to scan"
          exit 0
        fi
        
        # Check for actual vulnerabilities
        if grep -q "has the following vulnerable packages" vulnerability-report.txt; then
          echo "ðŸš¨ Vulnerable packages found!"
          cat vulnerability-report.txt
          exit 1
        else
          echo "âœ… No vulnerable packages found"
        fi

    - name: Check for deprecated packages
      run: |
        echo "Checking for deprecated NuGet packages..."
        dotnet list package --deprecated > deprecated-report.txt 2>&1
        
        # Check if the scan actually found any projects
        if grep -q "No projects found" deprecated-report.txt; then
          echo "âš ï¸  No projects found to scan"
          exit 0
        fi
        
        # Check for deprecated packages (this is informational, not a failure)
        if grep -q "deprecated" deprecated-report.txt; then
          echo "âš ï¸  Deprecated packages found:"
          cat deprecated-report.txt
        else
          echo "âœ… No deprecated packages found"
        fi

    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          vulnerability-report.txt
          deprecated-report.txt
        retention-days: 30

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    if: inputs.run_codeql != false
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: csharp

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Build
      run: |
        dotnet restore
        dotnet build --configuration Release

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    if: inputs.run_trufflehog != false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get commit range for scanning
      id: commit-range
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "base=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          echo "head=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          echo "scan_type=diff" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" != "refs/heads/main" ]; then
          echo "base=${{ github.event.before }}" >> $GITHUB_OUTPUT
          echo "head=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "scan_type=diff" >> $GITHUB_OUTPUT
        else
          echo "scan_type=full" >> $GITHUB_OUTPUT
        fi

    - name: Run TruffleHog (Full Repository Scan)
      if: steps.commit-range.outputs.scan_type == 'full' || inputs.scan_depth == 'full'
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        extra_args: --debug --only-verified

    - name: Run TruffleHog (Diff Scan)
      if: (steps.commit-range.outputs.scan_type == 'diff' && inputs.scan_depth != 'full') || inputs.scan_depth == 'recent'
      uses: trufflesecurity/trufflehog@main
      continue-on-error: true
      with:
        path: ./
        base: ${{ steps.commit-range.outputs.base }}
        head: ${{ steps.commit-range.outputs.head }}
        extra_args: --debug --only-verified

    - name: Run TruffleHog (Shallow Scan)
      if: inputs.scan_depth == 'shallow'
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        extra_args: --debug --only-verified --max-depth=1

    - name: Fallback TruffleHog (Full Scan on Diff Failure)
      if: (steps.commit-range.outputs.scan_type == 'diff' && failure()) && inputs.scan_depth != 'shallow'
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        extra_args: --debug --only-verified